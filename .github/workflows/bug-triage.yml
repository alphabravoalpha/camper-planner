# Bug Triage Workflow
# Automatically runs diagnostics when a bug issue is created (e.g. from Google Form)
# Labels: "bug", "auto-triage"

name: Bug Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    # Only run on issues with the "bug" label
    if: contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        id: typecheck
        continue-on-error: true
        run: npm run type-check 2>&1 | tail -50 > typecheck-output.txt

      - name: Run linter
        id: lint
        continue-on-error: true
        run: npm run lint 2>&1 | tail -50 > lint-output.txt

      - name: Run tests
        id: tests
        continue-on-error: true
        run: npm test -- --reporter=verbose 2>&1 | tail -80 > test-output.txt

      - name: Build check
        id: build
        continue-on-error: true
        run: npm run build 2>&1 | tail -30 > build-output.txt

      - name: Post diagnostics comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const read = (f) => {
              try { return fs.readFileSync(f, 'utf8').trim(); }
              catch { return 'No output'; }
            };

            const pass = (step) => step === 'success';
            const icon = (ok) => ok ? '\\u2705' : '\\u274c';

            const typeOk = '${{ steps.typecheck.outcome }}' === 'success';
            const lintOk = '${{ steps.lint.outcome }}' === 'success';
            const testOk = '${{ steps.tests.outcome }}' === 'success';
            const buildOk = '${{ steps.build.outcome }}' === 'success';

            let body = `## Automated Bug Triage\n\n`;
            body += `| Check | Status |\n|-------|--------|\n`;
            body += `| TypeScript | ${icon(typeOk)} ${typeOk ? 'Pass' : 'Fail'} |\n`;
            body += `| Linter | ${icon(lintOk)} ${lintOk ? 'Pass' : 'Fail'} |\n`;
            body += `| Tests | ${icon(testOk)} ${testOk ? 'Pass' : 'Fail'} |\n`;
            body += `| Build | ${icon(buildOk)} ${buildOk ? 'Pass' : 'Fail'} |\n\n`;

            if (!typeOk || !lintOk || !testOk || !buildOk) {
              body += `### Failures detected\n\n`;
              if (!typeOk) body += `<details><summary>TypeScript errors</summary>\n\n\`\`\`\n${read('typecheck-output.txt')}\n\`\`\`\n</details>\n\n`;
              if (!lintOk) body += `<details><summary>Lint errors</summary>\n\n\`\`\`\n${read('lint-output.txt')}\n\`\`\`\n</details>\n\n`;
              if (!testOk) body += `<details><summary>Test failures</summary>\n\n\`\`\`\n${read('test-output.txt')}\n\`\`\`\n</details>\n\n`;
              if (!buildOk) body += `<details><summary>Build errors</summary>\n\n\`\`\`\n${read('build-output.txt')}\n\`\`\`\n</details>\n\n`;
            } else {
              body += `All automated checks pass. This may be a runtime/UX issue that requires manual investigation.\n\n`;
            }

            body += `---\n*Automated triage by GitHub Actions*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
